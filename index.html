<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Binance Signal Group â€” Admin-Only Chat + Members (100 Countries) + Profit Cards (Real Prices)</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://db.onlinewebfonts.com/c/d05c19ccecf7003d248c60ffd6b5e8f7?family=Binance+PLEX" rel="stylesheet"/>

<style>
  :root{
    /* LIGHT THEME */
    --bg:#e7f9ec;
    --panel:#ffffff;
    --panel2:#f4f8fd;
    --text:#0f172a;
    --muted:#6b7280;
    --accent:#2a9df4;
    --border:#e5edf5;
    --chip:#e8f3ff;

    /* Bubbles */
    --bubble:#ffffff;
    --bubble-border:#e6edf5;
    --bubble-shadow:0 6px 18px rgba(17,24,39,0.06);

    /* NEW PROFIT CARD COLORS */
    --greenNew:#2cbc84;   /* Long label + green numbers */
    --shortNew:#982a3a;   /* Short label color (NEW) */

    /* New profit card bottom line â€” tuned to the uploaded example */
    --nx-line-color:#1f1f1f;     /* core line color (very dark grey) */
    --nx-line-soft:#0000001a;    /* soft fade edges */

    /* Footer PNG micro-adjusts (UPDATED as requested) */
    --footer-nudge-x: -0.4cm; /* move PNG 0.4cm left */
    --footer-nudge-y: -0.1cm; /* move PNG 0.1cm up  */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh;}

  /* Header */
  header{position:sticky; top:0; z-index:10; border-bottom:1px solid var(--border); background:var(--panel); padding:8px 12px;}
  .head-inner{max-width:820px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:10px;}

  /* UPDATED: use image logo (much bigger) */
  .logo{
    width:64px; height:64px;        /* made much larger */
    flex:0 0 64px;
    display:grid; place-items:center;
    border-radius:12px;              /* slight rounding to look neat */
    background:transparent;
    overflow:hidden;
  }
  .logo img{
    width:100%; height:100%;
    object-fit:contain; object-position:center;
    display:block;
  }

  .titles{display:flex; flex-direction:column; line-height:1.05; align-items:flex-start}
  .titles h1{margin:0; font-size:15px; font-weight:700}
  .titles .sub{color:#6b7280; font-size:12px; margin-top:2px}

  /* Layout */
  main{display:grid; grid-template-columns:330px 1fr; gap:0; min-height:0;}
  aside{grid-column:1; border-right:1px solid var(--border); background:var(--panel); display:flex; flex-direction:column; min-height:0}
  .chat{grid-column:2; display:flex; flex-direction:column; min-height:0;}
  .chat-head{padding:6px 16px; border-bottom:1px solid var(--border); background:var(--panel2); min-height:1px}
  .chat-scroll{flex:1; overflow:auto; padding:16px; background:
      radial-gradient(1200px 400px at 20% -10%, rgba(42,157,244,0.08), transparent 50%),
      linear-gradient(180deg, #f6fbff, var(--bg)); position:relative;}

  /* Top loader */
  .top-loader{position:sticky; top:0; left:0; right:0; display:flex; align-items:center; justify-content:center; padding:8px 10px; margin:-16px -16px 8px -16px; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.75)); border-bottom:1px solid var(--border); z-index:3;}
  .top-loader[hidden]{display:none;}
  .spin{width:16px; height:16px; border-radius:50%; border:2px solid #c8ddff; border-top-color:#2563eb; animation:sp 0.8s linear infinite;}
  @keyframes sp{to{transform:rotate(360deg)}}

  /* Bubble */
  .bub{max-width:74%; margin:10px 0; padding:12px 14px; border-radius:16px; line-height:1.4; font-size:14px; border:1px solid var(--bubble-border); background:var(--bubble); box-shadow:var(--bubble-shadow);}
  .bub.admin{margin-left:auto}
  .bub .meta{font-size:11px; color:var(--muted); margin-top:6px; text-align:right}
  .bub.admin:has(.nx-card), .bub.admin:has(.pcard), .bub.admin:has(img.msg-photo){background:transparent; border:none; box-shadow:none; padding:0;}
  .bub.admin:has(.nx-card) .meta, .bub.admin:has(.pcard) .meta, .bub.admin:has(img.msg-photo) .meta{padding-top:6px}

  /* >>> Shift ALL profit cards ~3cm to the LEFT (requested) */
  .bub.admin:has(.nx-card),
  .bub.admin:has(.pcard),
  .bub.admin:has(img.msg-photo){
    transform: translateX(-3cm);
  }

  /* Members */
  .aside-head{padding:12px; border-bottom:1px solid var(--border); display:grid; gap:10px; background:var(--panel)}
  .search{display:flex; gap:8px}
  .search input{flex:1; background:#f3f8ff; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:10px 12px; outline:none;}
  .members{overflow:auto; padding:8px 8px 14px; background:var(--panel)}
  .row{display:grid; grid-template-columns:42px 1fr auto; gap:10px; align-items:center; padding:8px; border-radius:12px; border:1px solid var(--border); background:#ffffff; margin-bottom:8px}
  .av{width:42px; height:42px; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#ffffff; border:1px solid rgba(0,0,0,.06); letter-spacing:.3px; overflow:hidden;}
  .av img{width:100%; height:100%; object-fit:cover; display:block}
  .name{font-weight:600; font-size:13px}
  .status{display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:600; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#f8fbff; color:#1f2937;}
  .dot{width:8px; height:8px; border-radius:999px; display:inline-block}
  .online .dot{background:#10b981} .offline .dot{background:#9ca3af}

  /* Mobile layout + Trigger behavior */
  .m-trigger{
    display:none;                     /* hidden on PC */
    align-items:center; gap:8px;
    padding:10px 12px; border-radius:10px;
    border:1px solid var(--border); background:#e9f4ff;
    font-weight:700; font-size:14px; color:#0f172a;
  }
  .m-trigger svg{width:18px;height:18px;opacity:.9}

  @media (max-width: 980px){
    main{grid-template-columns:1fr}
    aside{order:-1}

    /* show trigger on mobile */
    .m-trigger{display:inline-flex}

    /* collapsed state (default on mobile): only show the trigger strip;
       expand on click to reveal search + members */
    aside.collapsed .search,
    aside.collapsed .members{
      display:none;
    }
    aside{
      position:relative;
      z-index:20;
      border-right:0;
      border-bottom:1px solid var(--border);
    }
  }

  /* ---- OLD Profit Card (kept) ---- */
  .pcard{
    max-width:300px; width:min(90vw,300px);
    background:url('https://iili.io/KKAe9kv.md.gif') center/cover no-repeat;
    color:#fff; border-radius:10px; padding:0.5cm 14px; position:relative; overflow:hidden;
    box-shadow:0 8px 40px rgba(0,0,0,.25);
    font-family:"Binance PLEX","Segoe UI",Arial,sans-serif;
    font-variant-numeric:tabular-nums;
  }
  .pcard .inner{ transform:translateX(0.55cm); }
  .pcard .header{ display:flex; align-items:flex-start; gap:4px; margin-bottom:0.35cm; transform:translateX(-0.5cm); }
  .pcard .binance-logo{ width:11px; height:11px; margin-top:2px; }
  .pcard .text-block{ display:flex; flex-direction:column; margin-top:1px; }
  .pcard .binance-text{ font-weight:800; font-size:.45rem; color:#f0b90b; letter-spacing:.25px; }
  .pcard .futures-text{ font-size:.5rem; color:#fff; font-weight:700; line-height:1; }
  .pcard .trade-info{ margin:4px 0; font-size:.45rem; font-weight:600; display:flex; gap:0.25cm; }
  .pcard .short{ color:#ff4d6b; } .pcard .long{ color:#00c292; }
  .pcard .percentage{ font-size:1.2rem; font-weight:900; margin:5px 0; }
  .pcard .percentage.green{ color:#00c292; font-size:1.35rem; }
  .pcard .percentage.red{ color:#ff4d6b; }
  .pcard .price-section{ margin:5px 0 6px; }
  .pcard .price-line{ display:flex; justify-content:flex-start; gap:5px; margin-bottom:2px; }
  .pcard .price-label{ color:#ccc; font-size:.45rem; width:65px; font-weight:700; }
  .pcard .price-value{ color:#f0b90b; font-weight:800; font-size:.55rem; margin-left:12px; }
  .pcard .referral-section{ display:flex; align-items:center; gap:6px; margin-top:0.25cm; }
  .pcard .qr{ width:24px; height:24px; border-radius:4px; border:1px solid rgba(255,255,255,.18); object-fit:cover; }
  .pcard .ref-text{ font-size:.42rem; color:#ddd; font-weight:600; }
  .pcard .referral-code{ font-weight:800; font-size:.55rem; letter-spacing:.2px; }
  .pcard .app-text{ font-size:.42rem; color:#f0b90b; margin-top:0; font-weight:700; }

  /* ---- NEW Profit Card ---- */
  .nx-card{
    width:320px; border-radius:16px; overflow:hidden;
    background:#111 center/cover no-repeat;
    border:2px solid #2e2e2e; box-shadow:0 8px 24px rgba(0,0,0,.25);
    color:#fff; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    will-change: background-image;
  }
  .nx-header{ padding:16px; display:flex; align-items:center; gap:12px; margin-bottom:calc(16px + 1cm); }
  .nx-av{ width:34px; height:34px; aspect-ratio:1/1; border-radius:50%; overflow:hidden; flex:0 0 34px; box-shadow:0 0 0 2px rgba(255,255,255,.08); display:grid; place-items:center; background:#000; --av-shift: 0.004cm; }
  .nx-av img{ width:100%; height:100%; display:block; object-fit:cover; object-position:center; border-radius:50%; transform: translateY(var(--av-shift)); will-change: transform; }
  .nx-user{ display:flex; flex-direction:column; line-height:1.1; }
  .nx-name{ font-weight:600; font-size:15px; }
  .nx-time{ font-size:11px; opacity:.9; display:block; margin-top:0.08cm; transform: translateY(0.02cm); }
  .nx-body{ padding:0 16px calc(20px + 1cm); }
  .nx-title{ font-size:16px; font-weight:800; text-transform:uppercase; letter-spacing:.2px; }

  /* â†“â†“â†“ MATCH SIZES: Long/Short + Leverage = Entry Price label size (11px) */
  .nx-pos{ margin:6px 0 10px; display:inline-flex; align-items:center; gap:10px; font-size:11px; font-weight:600; }
  .nx-pos .nx-short{ color:var(--shortNew); }
  .nx-pos .nx-long{ color:var(--greenNew); }
  .nx-div{ width:1px; height:12px; background:#6a6a6a; display:inline-block; }
  .nx-lev{ color:#8c9692; font-size:inherit; }

  .nx-pnl{ display:flex; align-items:baseline; gap:8px; margin:6px 0 8px; }
  .nx-usd,.nx-roi{ font-size:32px; font-weight:800; letter-spacing:-.4px; }
  .nx-u,.nx-percent{ font-size:16px; font-weight:700; }
  .posG{ color:var(--greenNew); }
  .posR{ color:#ff6b6b; }

  /* â†“â†“â†“ Entry/Last prices slightly lower */
  .nx-prices{ position:relative; display:flex; justify-content:space-between; gap:16px; font-size:12px; margin-top:6px; }
  .nx-label{ color:#9a9a9a; font-size:11px; }
  .nx-value{ color:#fff; }
  .nx-last{ position:relative; left:-2.6cm; }

  /* Bottom section */
  .nx-foot{ background:#000; }
  .nx-line{
    display:block; width:100%; height:1.5px; margin-top:6px;
    background:
      linear-gradient(180deg,
        var(--nx-line-soft) 0%,
        var(--nx-line-color) 48%,
        var(--nx-line-color) 52%,
        var(--nx-line-soft) 100%);
  }
  .nx-footc{ padding:14px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }

  /* FOOTER LEFT BLOCK */
  .nx-id{
    display:grid;
    grid-template-columns: 12px 1fr;   /* col 2 = text/image start */
    grid-template-rows: auto auto;
    column-gap:8px; row-gap:4px;
    align-items:start;
    margin-left:-6px;
    position:relative;
  }
  .nx-footer-img{
    grid-column: 2/3; grid-row: 1/2;
    width:100px;
    height:auto;
    transform: translate(var(--footer-nudge-x), var(--footer-nudge-y));
    display:block;
    filter: drop-shadow(0 0 0 rgba(0,0,0,0));
  }
  .nx-ref{
    grid-column: 2/3; grid-row: 2/3;
    font-size:11px; line-height:1.1; color:#ffffff; letter-spacing:.1px;
    display:inline-block;
    transform: translateX(0.1cm);
  }

  /* QR */
  .nx-qr{
    width:54px; height:54px; background:#fff; border-radius:6px; overflow:hidden; display:block; box-shadow:inset 0 0 0 1px #e5e5e5;
    transform: translate(-0.1cm, 0);
  }
  .nx-qr img{ width:100%; height:100%; object-fit:contain; }

  /* Composer */
  .composer{ position:sticky; bottom:0; left:0; right:0; background:var(--panel); border-top:1px solid var(--border); padding:8px 12px; display:flex; align-items:center; gap:8px; z-index:5; }
  .c-emoji{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--border);background:#fff;cursor:pointer}
  .composer .box{ flex:1; display:flex; align-items:center; gap:8px; background:#f7fbff; border:1px solid var(--border); border-radius:999px; padding:8px 12px; }
  .composer input[type="text"]{ flex:1; border:none; background:transparent; outline:none; font-size:14px; color:var(--text); }
  .c-icon{width:22px;height:22px; display:grid; place-items:center; cursor:pointer; opacity:.8}
  .send{ width:40px;height:40px;border-radius:999px;background:#1da1ff;border:none;color:#fff;font-weight:700;cursor:pointer; display:grid;place-items:center; }
  .send:active{transform:translateY(1px)}

  /* Manual photo size = profit card width */
  img.msg-photo{max-width:min(85vw,520px); height:auto; border-radius:14px; display:block}
  .preview-note{font-size:12px; color:#2563eb; margin-left:6px}

  /* ==== NEW: VIP JOIN badge (fixed top-left, glowing gold) ==== */
  .vip-badge{
    position:fixed; top:10px; left:10px; z-index:9999;
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:linear-gradient(135deg,#3b3b3b,#0f0f0f);
    border:1px solid rgba(255,215,0,.35);
    box-shadow:0 0 0 2px rgba(0,0,0,.25), 0 0 18px rgba(255,215,0,.35), inset 0 0 12px rgba(255,215,0,.18);
    color:#ffd700; font-weight:800; letter-spacing:.3px; text-transform:uppercase; font-size:12px;
    user-select:none; -webkit-user-select:none;
  }
  .vip-badge .shine{
    position:absolute; inset:0; border-radius:999px; pointer-events:none;
    background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.35) 45%, transparent 60%);
    transform:skewX(-20deg) translateX(-120%);
    animation:vipshine 3s ease-in-out infinite;
  }
  @keyframes vipshine{
    0%{transform:skewX(-20deg) translateX(-120%);}
    55%{transform:skewX(-20deg) translateX(120%);}
    100%{transform:skewX(-20deg) translateX(120%);}
  }
  .vip-ico{
    width:18px;height:18px; display:inline-block;
    filter: drop-shadow(0 0 6px rgba(255,215,0,.55));
  }
</style>

<!-- Keep manual-upload photos same width as 320px profit card -->
<style>
  .bub.admin:has(img.msg-photo){ max-width: 320px; padding: 0; border: none; background: transparent; box-shadow: none; }
  img.msg-photo{ width: 320px; max-width: 320px; height: auto; display: block; border-radius: 16px; }
  @media (max-width: 380px){
    .bub.admin:has(img.msg-photo){ max-width: 90vw; }
    img.msg-photo{ width: 90vw; max-width: 90vw; }
  }

  /* >>> HIDE "Admin" label under manually-uploaded photos ONLY */
  .bub.admin:has(img.msg-photo) .meta{ display:none !important; }
</style>
</head>
<body>
<!-- ==== NEW: VIP JOIN fixed badge (left-top edge) ==== -->
<div class="vip-badge" title="Join VIP">
  <svg class="vip-ico" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M7.5 9l4.5-6 4.5 6 5-2-3 12H5L2.5 7zM8 19h8v2H8z"></path>
  </svg>
  <span>VIP JOIN</span>
  <span class="shine" aria-hidden="true"></span>
</div>

<div class="wrap">
  <!-- Centered Header -->
  <header>
    <div class="head-inner" aria-live="polite">
      <!-- UPDATED: image logo -->
      <div class="logo">
        <img src="https://iili.io/KLofm91.jpg" alt="ZYGO logo">
      </div>
      <div class="titles">
        <h1>ZYGO</h1>
        <div class="sub" id="khMembers">â€” members</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Members (LEFT) -->
    <aside id="membersPanel" class="collapsed">
      <div class="aside-head">
        <!-- Mobile-only TRIGGER above the search bar -->
        <button id="mTrigger" class="m-trigger" aria-expanded="false" aria-controls="membersPanel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
          </svg>
          Members
        </button>

        <div class="search">
          <input id="search" placeholder="Search membersâ€¦"/>
        </div>
      </div>
      <div class="members" id="members"></div>
    </aside>

    <!-- Chat Area -->
    <section class="chat">
      <div class="chat-head"></div>

      <div class="chat-scroll" id="chatScroll">
        <!-- TOP sticky loader (spinner ONLY) -->
        <div id="topLoader" class="top-loader" role="status" aria-live="polite" hidden>
          <span class="spin" aria-hidden="true"></span>
        </div>
      </div>

      <!-- Bottom Message Composer -->
      <div class="composer">
        <div class="c-emoji" title="Emoji">ðŸ˜Š</div>
        <div class="box">
          <input id="msgInput" type="text" placeholder="Message"/>
          <span class="c-icon" title="Attach">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 1 1-8.49-8.49l10.6-10.6a4 4 0 0 1 5.66 5.66L9.88 17.95a2 2 0 1 1-2.83-2.83l9.19-9.19"/></svg>
          </span>
          <span class="c-icon" id="imgBtn" title="Photo">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
          </span>
          <input id="imgInput" type="file" accept="image/*" hidden>
          <span id="imgPreviewNote" class="preview-note" hidden>Photo ready to send</span>
        </div>
        <button class="send" id="sendBtn" aria-label="Send">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </section>
  </main>
</div>

<script>
/* ====================== UTILS ====================== */
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')}

/* ===== Header count ===== */
const min = 320000, max = 340000;
const total = Math.floor(Math.random()*(max-min+1))+min;
document.getElementById('khMembers').textContent = numberWithCommas(total) + ' members';

/* ====================== TIMEZONE: Asia/Colombo ====================== */
const TZ = 'Asia/Colombo';
function ymdColombo(d){
  return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
}
function colomboMidnightBounds(dateLike){
  const d = new Date(dateLike);
  const parts = ymdColombo(d).split('-'); // YYYY-MM-DD
  const y = +parts[0], m = +parts[1]-1, day = +parts[2];
  const atColombo = new Date(Date.UTC(y,m,day,0,0,0));
  const offMin = -new Date(atColombo.toLocaleString('en-US',{timeZone:TZ})).getTimezoneOffset();
  const startUTC = new Date(Date.UTC(y,m,day,0,0,0) - (offMin*60000));
  const endUTC   = new Date(startUTC.getTime() + 86400000 - 1);
  return {startUTC, endUTC};
}
function todayColomboYMD(){ return ymdColombo(new Date()); }

/* ====================== PHOTO GROUPS (de-duplicated) ====================== */
const PH_G1 = Array.from(new Set([
  "https://iili.io/K6t61ln.jpg","https://iili.io/K6t4Naa.jpg","https://iili.io/K6tUy6g.jpg","https://iili.io/K6tUThP.jpg",
  "https://iili.io/K6t8ESR.jpg","https://iili.io/K6tvh4j.jpg","https://iili.io/K6tkVgR.jpg","https://iili.io/K6tOgCG.jpg",
  "https://iili.io/K6twpDu.jpg","https://iili.io/K6twaMx.jpg","https://iili.io/K6tw2yX.jpg","https://iili.io/K6tj0pn.jpg",
  "https://iili.io/K6thQs4.jpg","https://iili.io/K6tXmNa.jpg","https://iili.io/K6tW51S.jpg"
]));
const PH_G2 = Array.from(new Set([
  "https://iili.io/K6bItu1.jpg","https://iili.io/K6bzb14.jpg","https://iili.io/K6bz7JS.jpg","https://iili.io/K6bxkKl.jpg",
  "https://iili.io/K6bxzFV.jpg","https://iili.io/K6boUZJ.jpg","https://iili.io/K6bon2I.jpg","https://iili.io/K6bnkXf.jpg",
  "https://iili.io/K6bCQKN.jpg","https://iili.io/K6bCA9n.jpg","https://iili.io/K6bBDjj.jpg","https://iili.io/K6bBYrP.jpg",
  "https://iili.io/K6bqV07.jpg","https://iili.io/K6bfsPS.jpg","https://iili.io/K6bKl7s.jpg","https://iili.io/K6bFRUu.jpg",
  "https://iili.io/K6b3anI.jpg","https://iili.io/K6b2AL7.jpg","https://iili.io/K6bdSfe.jpg","https://iili.io/K6bJPnt.jpg",
  "https://iili.io/K6Df3Ja.jpg","https://iili.io/K6DKEAv.jpg","https://iili.io/K6D298x.jpg","https://iili.io/K6Ddf2f.jpg",
  "https://iili.io/K6DJXbS.jpg"
]));
const PH_G3 = Array.from(new Set([
  "https://iili.io/K6mC7Xj.jpg","https://iili.io/K6mBEDG.jpg","https://iili.io/K6mqbFS.jpg","https://iili.io/K6mq5ve.jpg",
  "https://iili.io/K6mfrIj.jpg","https://iili.io/K6m3vdg.jpg","https://iili.io/K6m3uef.jpg","https://iili.io/K6m2jln.jpg",
  "https://iili.io/K6mdF2a.jpg","https://iili.io/K6mJAbV.jpg","https://iili.io/K6mHkNV.jpg","https://iili.io/K6m9qp2.jpg",
  "https://iili.io/K6by6LF.jpg","https://iili.io/K6byqWF.jpg","https://iili.io/K6bpYcx.jpg"
]));
const PH_G4 = Array.from(new Set([
  "https://iili.io/K6mghCB.jpg","https://iili.io/K6mUUq7.jpg","https://iili.io/K6mUKle.jpg","https://iili.io/K6mSIFn.jpg",
  "https://iili.io/K6m80YJ.jpg","https://iili.io/K6mvGs9.jpg","https://iili.io/K6mkLPe.jpg","https://iili.io/K6mkfu2.jpg",
  "https://iili.io/K6meWQ9.jpg","https://iili.io/K6mOpgj.jpg","https://iili.io/K6mOIVe.jpg","https://iili.io/K6mNM8l.jpg",
  "https://iili.io/K6mNd3x.jpg","https://iili.io/K6mwO2R.jpg","https://iili.io/K6mwB1f.jpg","https://iili.io/K6mjUfj.jpg",
  "https://iili.io/K6mjaRI.jpg","https://iili.io/K6mhI3l.jpg"
]));

/* consume once helpers */
function popOne(list){ if(!list.length) return null; return list.splice(Math.floor(Math.random()*list.length),1)[0]; }

/* ====================== NAME POOLS ====================== */
const SL_Boys_First = ["Kasun","Nimal","Tharindu","Supun","Sahan","Harsha","Dinuka","Isuru","Chathura","Ravindu","Shehan","Gayan","Pasindu","Udara","Lahiru"];
const IN_Boys_First = ["Arjun","Rohit","Rahul","Aman","Vikram","Karan","Sahil","Aditya","Vijay","Rakesh","Ankur","Manish","Arnav","Kabir","Dev"];
const IN_PK_Girls_First = ["Priya","Ananya","Aisha","Zoya","Meera","Kiran","Sana","Riya","Nisha","Hina","Iqra","Mira","Pooja","Simran","Alina"];
const VN_First = ["Ngoc","Anh","Linh","Trang","Huong","Phuong","Thao","Quynh","Duc","Huy","Minh","Nam","Tuan","Hang","My"];
const RU_First = ["Ivan","Dmitry","Sergei","Alexey","Nikolai","Anna","Olga","Svetlana","Maria","Elena","Yuri","Tatiana","Viktor","Artem","Polina"];
const UK_First = ["James","Oliver","Harry","George","Jack","Charlie","Amelia","Isla","Ava","Olivia","Emily","Noah","Sophia","Mia","Lucas"];

const SL_Last = ["Perera","Silva","Fernando","Jayasinghe","Bandara","Wijesinghe","Gunasekara","Senanayake","Ekanayake","Karunaratne"];
const IN_Last = ["Kumar","Sharma","Verma","Gupta","Singh","Reddy","Iyer","Patel","Khan","Das"];
const PK_Last = ["Ahmed","Hussain","Malik","Khan","Shah","Ali","Raza","Siddiqui","Chaudhry","Farooq"];
const VN_Last = ["Nguyen","Tran","Le","Pham","Hoang","Pham","Bui","Vo","Dang","Do"];
const RU_Last = ["Ivanov","Smirnov","Kuznetsov","Popov","Sokolov","Volkov","Fedorov","Mikhailov","Orlov","Pavlov"];
const UK_Last = ["Smith","Johnson","Brown","Taylor","Wilson","Davies","Evans","Thomas","Roberts","Walker"];

/* fallback mixed pools */
const OTHER_First = ["Diego","Luca","Marco","Sven","Marta","Aiko","Yuna","Jin","Lucas","Theo","Liam","Chloe","Nora","Milan","Zara","Hassan","Yara"];
const OTHER_Last  = ["Garcia","Rossi","Muller","Hansen","Novak","Santos","Costa","Lee","Kim","Nguyen","Park","Kaya","Yilmaz"];

/* unique name registry */
const usedNames = new Set();
function uniqueJoin(first, last){
  let full = `${first} ${last}`;
  if(!usedNames.has(full)){ usedNames.add(full); return full; }
  let n = 2;
  while(usedNames.has(`${full} ${n}`)) n++;
  full = `${full} ${n}`;
  usedNames.add(full);
  return full;
}

/* generators by group */
function nameFromGroup(group){
  switch(group){
    case 1:{ // SL + IN boys
      const isSL = Math.random()<0.5;
      const f = isSL ? pick(SL_Boys_First) : pick(IN_Boys_First);
      const l = isSL ? pick(SL_Last) : pick(IN_Last);
      return uniqueJoin(f,l);
    }
    case 2:{ // IN + PK girls
      const isIN = Math.random()<0.5;
      const f = pick(IN_PK_Girls_First);
      const l = isIN ? pick(IN_Last) : pick(PK_Last);
      return uniqueJoin(f,l);
    }
    case 3:{ // Vietnam
      return uniqueJoin(pick(VN_First), pick(VN_Last));
    }
    case 4:{ // Russian + UK
      const isRU = Math.random()<0.5;
      const f = isRU ? pick(RU_First) : pick(UK_First);
      const l = isRU ? pick(RU_Last)  : pick(UK_Last);
      return uniqueJoin(f,l);
    }
    default:{
      const pools = [
        ()=>uniqueJoin(pick(SL_Boys_First), pick(SL_Last)),
        ()=>uniqueJoin(pick(IN_Boys_First), pick(IN_Last)),
        ()=>uniqueJoin(pick(IN_PK_Girls_First), pick(PK_Last)),
        ()=>uniqueJoin(pick(VN_First), pick(VN_Last)),
        ()=>uniqueJoin(pick(RU_First), pick(RU_Last)),
        ()=>uniqueJoin(pick(UK_First), pick(UK_Last)),
        ()=>uniqueJoin(pick(OTHER_First), pick(OTHER_Last))
      ];
      return pick(pools)();
    }
  }
}

/* ====================== MEMBERS BUILD (1â€“3 photos per 10) ====================== */
const members = [];
const seedCount = 1200;

/* Per 10 members, pick 1..3 photo slots at random (no duplicates) */
const photoIndices = new Set();
for(let base=0; base<seedCount; base+=10){
  const countInBlock = 1 + Math.floor(Math.random()*3); // 1..3
  const slots = new Set();
  while(slots.size < countInBlock){
    slots.add(base + Math.floor(Math.random()*10));
  }
  slots.forEach(i=>photoIndices.add(i));
}

/* Build members with mapping rules */
for(let i=0;i<seedCount;i++){
  const hasPhoto = photoIndices.has(i);
  let name, photoUrl = null;

  if(hasPhoto){
    const groupsAvailable = [];
    if(PH_G1.length) groupsAvailable.push(1);
    if(PH_G2.length) groupsAvailable.push(2);
    if(PH_G3.length) groupsAvailable.push(3);
    if(PH_G4.length) groupsAvailable.push(4);

    if(groupsAvailable.length){
      const g = pick(groupsAvailable);
      name = nameFromGroup(g);
      if(g===1) photoUrl = popOne(PH_G1);
      else if(g===2) photoUrl = popOne(PH_G2);
      else if(g===3) photoUrl = popOne(PH_G3);
      else photoUrl = popOne(PH_G4);
    }else{
      name = nameFromGroup(0);
    }
  }else{
    name = nameFromGroup(0);
  }

  const status = Math.random()<0.55 ? 'online' : 'offline';
  members.push({ id:i+1, name, status, photoUrl });
}

/* ====== Renderers ====== */
const membersEl = document.getElementById('members');
const searchEl  = document.getElementById('search');
let viewSlice = 120; const PAGE=60;

function randomAvatarColor(){
  const hues = [205,150,45,265,10,185,95,320,25,140];
  const h = pick(hues), s = 75 + Math.floor(Math.random()*15), l = 52 + Math.floor(Math.random()*6);
  return `hsl(${h} ${s}% ${l}%)`;
}
function initialsFrom(name){
  const parts = name.trim().split(/\s+/);
  return ((parts[0]?.[0]||'') + (parts[1]?.[0]||'')).toUpperCase() || 'U';
}

function renderMembers(){
  const q = searchEl.value.toLowerCase().trim();
  const filtered = members.filter(m => q ? m.name.toLowerCase().includes(q) : true);
  const toShow = filtered.slice(0, viewSlice);
  membersEl.innerHTML = '';

  toShow.forEach(m=>{
    const row = document.createElement('div'); row.className='row';
    const badgeCls = m.status === 'online' ? 'online' : 'offline';
    const avHTML = m.photoUrl
      ? `<div class="av" aria-hidden="true"><img src="${m.photoUrl}" alt="${m.name} profile"></div>`
      : `<div class="av" aria-hidden="true" style="background:${randomAvatarColor()}">${initialsFrom(m.name)}</div>`;
    row.innerHTML = `${avHTML}
      <div><div class="name">${m.name}</div></div>
      <div class="status ${badgeCls}"><span class="dot"></span>${m.status==='online'?'Online':'Offline'}</div>`;
    membersEl.appendChild(row);
  });
}
searchEl.addEventListener('input', ()=>{ viewSlice = 120; renderMembers(); });
membersEl.addEventListener('scroll', e=>{
  if (membersEl.scrollTop + membersEl.clientHeight >= membersEl.scrollHeight-20){
    viewSlice += PAGE; renderMembers();
  }
});
renderMembers();

/* ============================ CHAT / CARDS ============================ */
const CHAT = document.getElementById('chatScroll');
const TOP_LOADER = document.getElementById('topLoader');
const DOM_CAP = 500;

/* ---------- Binance API ---------- */
const API = {
  futuresKlines: 'https://fapi.binance.com/fapi/v1/klines',
  tickerPrice:   'https://fapi.binance.com/fapi/v1/ticker/price',
  ping:          'https://fapi.binance.com/fapi/v1/ping'
};
const SYMBOLS = [
  'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','DOGEUSDT','ADAUSDT',
  'TONUSDT','AVAXUSDT','LINKUSDT','NEARUSDT','MATICUSDT','OPUSDT','ARBUSDT','ATOMUSDT'
];

/* ---------- Date list: from TODAY (Colombo) back to 2023-03-02 ---------- */
const CUTOFF = new Date('2023-03-02T00:00:00Z');
function buildDaysDescendingFromToday(){
  const days = [];
  const now = new Date();
  let {startUTC} = colomboMidnightBounds(now);
  for (let t=startUTC.getTime(); t>=CUTOFF.getTime(); t-=86400000){
    days.push(new Date(t));
  }
  return days;
}
const DAYS = buildDaysDescendingFromToday();

/* ---------- format helpers ---------- */
function dateYMD(d){ return new Date(d).toISOString().slice(0,10); }
function fmtPrice(n){
  return Number(n).toLocaleString(undefined,{minimumFractionDigits:3, maximumFractionDigits:6});
}
function fmt2(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ---------- cache ---------- */
const klinesCache = new Map();
async function loadDailyKlines(symbol, day){
  const {startUTC, endUTC} = colomboMidnightBounds(day);
  const key = `${symbol}:${startUTC.toISOString().slice(0,10)}`;
  if (klinesCache.has(key)) return klinesCache.get(key);

  const params = new URLSearchParams({
    symbol, interval:'1d',
    startTime: startUTC.getTime(),
    endTime: endUTC.getTime()
  });
  try{
    const res = await fetch(`${API.futuresKlines}?${params.toString()}`, {cache:'no-store'});
    if(!res.ok){ klinesCache.set(key,null); return null; }
    const data = await res.json();
    const row = Array.isArray(data) && data.length ? data[0] : null;
    if(!row){ klinesCache.set(key,null); return null; }
    const out = { openTime: row[0], open: parseFloat(row[1]), close: parseFloat(row[4]) };
    klinesCache.set(key,out);
    return out;
  }catch(_){ klinesCache.set(key,null); return null; }
}
async function loadCurrentPrice(symbol){
  try{
    const res = await fetch(`${API.tickerPrice}?symbol=${symbol}`, {cache:'no-store'});
    const j = await res.json();
    return parseFloat(j.price);
  }catch(_){ return null; }
}

/* backgrounds */
const NX_BACKGROUNDS = ['https://iili.io/Kgp9GJj.gif','https://iili.io/Kr9UiVR.gif'];
NX_BACKGROUNDS.forEach(src=>{ const img=new Image(); img.src=src; });

/* ---------- QR + REFERRAL POOL (NO DUPLICATES) ---------- */
const CUSTOM_QR_POOL = [
  { url:"https://iili.io/K6p8Q5J.jpg", code:"266486323" },
  { url:"https://iili.io/K6pvpcu.jpg", code:"361342455" },
  { url:"https://iili.io/K6pvYyx.jpg", code:"542025165" },
  { url:"https://iili.io/K6pkLEF.jpg", code:"481962935" },
  { url:"https://iili.io/K6pkCs1.jpg", code:"1024836096" },
  { url:"https://iili.io/K6pewla.jpg", code:"475308515" }
];

/* ======== NEW: Language packs & selector (â‰ˆ 1 in 10 cards VN/TH) ======== */
function langPackRandom(){
  // ~10% chance to switch from English. If switched, 50/50 VN or TH.
  const useAlt = Math.random() < 0.10;
  if(!useAlt){
    return { code:'EN', LONG:'Long', SHORT:'Short', ENTRY:'Entry Price', LAST:'Last Price' };
  }
  const isVN = Math.random() < 0.5;
  if(isVN){
    return { code:'VI', LONG:'Mua', SHORT:'BÃ¡n', ENTRY:'GiÃ¡ vÃ o lá»‡nh', LAST:'GiÃ¡ hiá»‡n táº¡i' };
  }else{
    return { code:'TH', LONG:'à¸‹à¸·à¹‰à¸­', SHORT:'à¸Šà¸­à¸£à¹Œà¸•', ENTRY:'à¸£à¸²à¸„à¸²à¹€à¸‚à¹‰à¸²', LAST:'à¸£à¸²à¸„à¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸”' };
  }
}

/* ---------- CARD TEMPLATES ---------- */
function makeProfitCardOld({side, leverage, symbol, entry, last, roiPct, pnlUSDT, ref, qrUrl, lp}){
  const wrap = document.createElement('div');
  wrap.className = 'pcard';
  wrap.innerHTML = `
    <div class="inner">
      <div class="header">
        <img class="binance-logo" src="https://iili.io/KKRCyss.th.png" alt="Binance Logo" />
        <div class="text-block">
          <div class="binance-text">BINANCE</div>
          <div class="futures-text">FUTURES</div>
        </div>
      </div>
      <div class="trade-info">
        <span class="${side==='LONG'?'long':'short'}">${side==='LONG'?lp.LONG:lp.SHORT}</span>
        <span>|</span><span>${leverage}x</span>
        <span>|</span><span>${symbol} Perpetual</span>
      </div>
      <div class="percentage ${roiPct>=0?'green':'red'}">${roiPct>=0?'+':''}${roiPct.toFixed(2)}%</div>
      <div class="price-section">
        <div class="price-line"><span class="price-label">${lp.ENTRY}</span><span class="price-value">${fmtPrice(entry)}</span></div>
        <div class="price-line"><span class="price-label">${lp.LAST}</span><span class="price-value">${fmtPrice(last)}</span></div>
      </div>
      <div class="referral-section">
        <img class="qr" src="${qrUrl || 'https://iili.io/K1dUMml.jpg'}" alt="QR Code"/>
        <div>
          <div class="ref-text">Referral Code</div>
          <div class="referral-code">${ref}</div>
          <div class="app-text">Get the Binance App</div>
        </div>
      </div>
    </div>`;
  return wrap;
}

function makeProfitCardNew({side, leverage, symbol, entry, last, roiPct, pnlUSDT, member, ymd, randomTime, ref, qrUrl, lp}){
  const wrap = document.createElement('div');
  wrap.className = 'nx-card';
  wrap.style.background = `#111 url("${pick(NX_BACKGROUNDS)}") center/cover no-repeat`;

  const positive = roiPct >= 0;
  const showROI = Math.random()<0.6 && Math.abs(roiPct)>=100;
  const pnlLine = showROI
    ? `<div class="nx-roi ${positive?'posG':'posR'}">${positive?'+':''}${roiPct.toFixed(2)}%</div><div class="nx-percent"></div>`
    : `<div class="nx-usd ${positive?'posG':'posR'}">${positive?'+':''}${fmt2(pnlUSDT)}</div><div class="nx-u">USDT</div>`;

  wrap.innerHTML = `
    <div class="nx-header">
      <div class="nx-av"><img src="https://iili.io/K10FPQ1.th.jpg" alt="${member.name}"></div>
      <div class="nx-user">
        <span class="nx-name">${member.name}</span>
        <span class="nx-time">${ymd} ${randomTime}</span>
      </div>
    </div>
    <div class="nx-body">
      <div class="nx-title">${symbol} PERPETUAL</div>
      <div class="nx-pos">
        <span class="${side==='LONG'?'nx-long':'nx-short'}">${side==='LONG'?lp.LONG:lp.SHORT}</span>
        <span class="nx-div"></span>
        <span class="nx-lev">${leverage}x</span>
      </div>
      <div class="nx-pnl">${pnlLine}</div>
      <div class="nx-prices">
        <div class="nx-entry"><div class="nx-label">${lp.ENTRY}</div><div class="nx-value">${fmtPrice(entry)}</div></div>
        <div class="nx-last"><div class="nx-label">${lp.LAST}</div><div class="nx-value">${fmtPrice(last)}</div></div>
      </div>
    </div>
    <div class="nx-foot">
      <span class="nx-line"></span>
      <div class="nx-footc">
        <div class="nx-id">
          <img class="nx-footer-img" src="https://iili.io/KrutTVp.png" alt="Footer image">
          <span class="nx-ref">Referral Code ${ref}</span>
        </div>
        <span class="nx-qr"><img src="${qrUrl || 'https://iili.io/KrdUz7I.jpg'}" alt="QR"></span>
      </div>
    </div>`;
  return wrap;
}

function makeAdminBubbleNode(innerNode, metaText){
  const b = document.createElement('div'); b.className = 'bub admin';
  b.appendChild(innerNode);
  if (metaText){ const m = document.createElement('div'); m.className='meta'; m.textContent = metaText; b.appendChild(m); }
  return b;
}

/* batching / infinite scroll */
let nextIndexTop = 0;
const INITIAL_DAYS = 12;
const BATCH_DAYS   = 6;
let preloading = false;
function showTopLoader(on){
  TOP_LOADER.hidden = !on;
  TOP_LOADER.setAttribute('aria-busy', on ? 'true' : 'false');
}

/* helpers */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* >>> randomized leverage pool kept as-is */
function chooseLeverageForROI(){
  const pool = [10, 20, 50, 100, 125];
  return pool[Math.floor(Math.random()*pool.length)];
}

function chooseNotionalForPNL(roiPct){
  const roiFactor = Math.abs(roiPct)/100 || 0.001;
  const minPNL=300, maxPNL=10000;
  const minNotional = minPNL / roiFactor;
  const maxNotional = maxPNL / roiFactor;
  const n = minNotional + Math.random()*(maxNotional - minNotional);
  return clamp(n, 50, 200000);
}

/* ---------- Build one day (real prices for that calendar day, Colombo) ---------- */
async function buildDayFragment(day, opts={}){
  const frag = document.createDocumentFragment();
  const cardsToday = opts.count ?? (10 + Math.floor(Math.random() * 6)); // [10..15]
  const needSymbols = new Set();
  while (needSymbols.size < Math.min(cardsToday, SYMBOLS.length)){
    needSymbols.add(pick(SYMBOLS));
  }

  // Preload daily klines for chosen symbols
  await Promise.all(Array.from(needSymbols).map(sym => loadDailyKlines(sym, day)));

  const isToday = ymdColombo(day) === todayColomboYMD();

  for (let c=0; c<cardsToday; c++){
    const symbol = pick(SYMBOLS);
    const k = await loadDailyKlines(symbol, day);
    if(!k) continue;

    const entry = k.open;
    let last  = k.close;

    // If it's TODAY in Colombo, use LIVE last price
    if (isToday){
      const live = await loadCurrentPrice(symbol);
      if (live && isFinite(live)) last = live;
    }

    const longPct  = ((last - entry) / entry) * 100;
    const shortPct = ((entry - last) / entry) * 100;
    const side = longPct >= shortPct ? 'LONG' : 'SHORT';
    const pctBase = side==='LONG' ? longPct : shortPct;

    const lev = Math.round(chooseLeverageForROI());
    const roiPct = pctBase * lev;

    const notional = chooseNotionalForPNL(roiPct);
    const pnlUSDT = notional * (roiPct/100);

    const member = members[(Math.random()*members.length)|0];
    const ymd = ymdColombo(day);
    const hh = String(Math.floor(Math.random()*24)).padStart(2,'0');
    const mm = String(Math.floor(Math.random()*60)).padStart(2,'0');
    const ss = String(Math.floor(Math.random()*60)).padStart(2,'0');
    const timeText = `${hh}:${mm}:${ss}`;

    const tempRef = String(Math.floor(100000000 + Math.random()*900000000));

    /* NEW: per-card language pack (â‰ˆ1/10 in VI or TH) */
    const lp = langPackRandom();

    const useNew = true;
    const node = useNew
      ? makeProfitCardNew({side, leverage:lev, symbol, entry, last, roiPct, pnlUSDT, member, ymd, randomTime:timeText, ref:tempRef, qrUrl:null, lp})
      : makeProfitCardOld({side, leverage:lev, symbol, entry, last, roiPct, pnlUSDT, ref:tempRef, qrUrl:null, lp});

    frag.appendChild(makeAdminBubbleNode(node, member.name));
  }
  return frag;
}

/* ================== QR ASSIGNMENT ON TAIL 20 ================== */
function assignQRCodesToTail(){
  try{
    const cards = Array.from(CHAT.querySelectorAll('.nx-card, .pcard'));
    if (cards.length === 0) return;

    const tail = cards.slice(-20);

    const idxs = new Set();
    while (idxs.size < Math.min(6, tail.length)){
      idxs.add(Math.floor(Math.random()*tail.length));
    }

    const pool = CUSTOM_QR_POOL.slice();
    shuffle(pool);

    let i = 0;
    for (const pos of idxs){
      if (!pool[i]) break;
      const card = tail[pos];
      const { url, code } = pool[i];

      if (card.classList.contains('nx-card')){
        const qrImg = card.querySelector('.nx-qr img');
        const refSpan = card.querySelector('.nx-ref');
        if (qrImg) qrImg.src = url;
        if (refSpan) refSpan.textContent = `Referral Code ${code}`;
      } else {
        const qrImg = card.querySelector('.qr');
        const refDiv = card.querySelector('.referral-code');
        if (qrImg) qrImg.src = url;
        if (refDiv) refDiv.textContent = code;
      }
      i++;
    }
  }catch(e){
    console.warn('QR assign error', e);
  }
}

/* ================== STORAGE for daily auto-add ================== */
const STORE_KEY = 'zygo_daily_cards';
function readStore(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); }catch(_){ return {}; }
}
function writeStore(obj){
  try{ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }catch(_){}
}

/* Ensure ~10 cards exist for a given Colombo date */
async function ensureDailyCardsFor(colomboDateStr){
  const store = readStore();
  if (!store[colomboDateStr]){
    const day = new Date(colomboDateStr+'T00:00:00');
    const frag = await buildDayFragment(day, {count:10});
    CHAT.appendChild(frag);
    CHAT.scrollTop = CHAT.scrollHeight;
    assignQRCodesToTail();
    store[colomboDateStr] = {count:10, createdAt: Date.now()};
    writeStore(store);
  }
}

/* Backfill small recent gap */
async function backfillMissingDays(){
  const store = readStore();
  const today = todayColomboYMD();

  const savedDays = Object.keys(store).sort();
  let startIdx = DAYS.findIndex(d => ymdColombo(d) === today);
  if (startIdx < 0) startIdx = 0;

  const need = [];
  for (let i=0, added=0; i<30 && added<3 && (startIdx+i)<DAYS.length; i++){
    const dStr = ymdColombo(DAYS[i]);
    if (!store[dStr]){ need.push(dStr); added++; }
  }
  need.reverse();
  for (const dStr of need){
    await ensureDailyCardsFor(dStr);
  }
}

/* Live refresh for today's last prices */
async function refreshTodayLastPrices(){
  const today = todayColomboYMD();
  const nodes = Array.from(CHAT.querySelectorAll('.nx-card'));
  if (!nodes.length) return;

  const todayNodes = nodes.filter(n=>{
    const t = n.querySelector('.nx-time')?.textContent || '';
    return t.startsWith(today);
  });

  const mapSymToLast = {};
  for (const n of todayNodes){
    const title = n.querySelector('.nx-title')?.textContent || '';
    const sym = (title.split(' ')[0] || '').trim();
    if (sym && !mapSymToLast[sym]){
      mapSymToLast[sym] = loadCurrentPrice(sym);
    }
  }
  const entries = await Promise.all(Object.entries(mapSymToLast).map(async([s,p])=>[s, await p]));
  const latest = Object.fromEntries(entries.filter(([,v])=>isFinite(v)));

  todayNodes.forEach(n=>{
    const title = n.querySelector('.nx-title')?.textContent || '';
    const sym = (title.split(' ')[0] || '').trim();
    const v = latest[sym];
    if (isFinite(v)){
      const lastVal = n.querySelector('.nx-last .nx-value');
      if (lastVal) lastVal.textContent = fmtPrice(v);
    }
  });
}

/* ========================== INIT ========================== */
(async function init(){
  try{ await fetch(API.ping, {cache:'no-store'}); }catch(e){ /* ignore */ }

  // Initial render for recent days
  for (let i=0; i<INITIAL_DAYS && i<DAYS.length; i++){
    const frag = await buildDayFragment(DAYS[i]);
    CHAT.appendChild(frag);
    nextIndexTop = i+1;
  }
  CHAT.scrollTop = CHAT.scrollHeight;

  assignQRCodesToTail();

  // Infinite scroll (older)
  CHAT.addEventListener('scroll', async ()=>{
    if (CHAT.scrollTop <= 100){
      if (preloading) return;
      preloading = true; showTopLoader(true);

      const before = CHAT.scrollHeight;
      const start = nextIndexTop;
      const end = Math.min(nextIndexTop + BATCH_DAYS, DAYS.length);

      for (let i=start; i<end; i++){
        const dayFrag = await buildDayFragment(DAYS[i]);
        const anchor = TOP_LOADER.nextSibling;
        if (anchor){ CHAT.insertBefore(dayFrag, anchor); } else { CHAT.prepend(dayFrag); }
      }

      nextIndexTop = end;

      const after = CHAT.scrollHeight;
      CHAT.scrollTop += (after - before);

      const bub = CHAT.querySelectorAll('.bub');
      const excess = Math.max(0, bub.length - DOM_CAP);
      for(let i=0;i<excess;i++) bub[i].remove();

      showTopLoader(false); preloading = false;

      assignQRCodesToTail();
    }
  });

  // Daily auto-add (~10 cards)
  const today = todayColomboYMD();
  await backfillMissingDays();
  await ensureDailyCardsFor(today);

  // Nightly rollover
  (function scheduleMidnightRollover(){
    const now = new Date();
    const {startUTC} = colomboMidnightBounds(new Date(now.getTime()+86400000));
    const msToNext = startUTC.getTime() - now.getTime();
    setTimeout(async ()=>{
      const newDay = todayColomboYMD();
      await ensureDailyCardsFor(newDay);
      scheduleMidnightRollover();
    }, Math.max(1000, msToNext));
  })();

  // Live last-price refresh (5 min)
  setInterval(refreshTodayLastPrices, 5*60*1000);
  refreshTodayLastPrices();
})();

/* ===== Composer (kept) ===== */
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');
const imgBtn = document.getElementById('imgBtn');
const imgInput = document.getElementById('imgInput');
const imgPreviewNote = document.getElementById('imgPreviewNote');

let queuedImageDataURL = null;
let queuedImageName = null;

imgBtn.addEventListener('click', ()=> imgInput.click());
imgInput.addEventListener('change', ()=>{
  const file = imgInput.files?.[0];
  if(!file){ queuedImageDataURL = null; queuedImageName = null; imgPreviewNote.hidden = true; return; }
  const reader = new FileReader();
  reader.onload = (e)=>{ queuedImageDataURL = e.target.result; queuedImageName = file.name || 'photo'; imgPreviewNote.hidden = false; };
  reader.readAsDataURL(file);
});

function appendTextMessage(text){
  const b = document.createElement('div'); b.className = 'bub admin'; b.textContent = text;
  const m = document.createElement('div'); m.className='meta'; m.textContent='Admin';
  b.appendChild(m); CHAT.appendChild(b); CHAT.scrollTop = CHAT.scrollHeight;
}
function appendPhotoMessage(dataURL, altText){
  const b = document.createElement('div'); b.className = 'bub admin';
  const img = document.createElement('img'); img.src = dataURL; img.alt = altText || 'photo'; img.className = 'msg-photo';
  b.appendChild(img);
  const m = document.createElement('div'); m.className='meta'; m.textContent='Admin';
  b.appendChild(m); CHAT.appendChild(b); CHAT.scrollTop = CHAT.scrollHeight;
}

sendBtn.addEventListener('click', ()=>{
  if (queuedImageDataURL){
    appendPhotoMessage(queuedImageDataURL, queuedImageName);
    queuedImageDataURL = null; queuedImageName = null; imgInput.value = ''; imgPreviewNote.hidden = true;
    const t = msgInput.value.trim(); if (t){ appendTextMessage(t); msgInput.value=''; }
    return;
  }
  const val = msgInput.value.trim(); if(!val) return; appendTextMessage(val); msgInput.value = '';
});

/* ===== Mobile-only members trigger ===== */
const mTrigger = document.getElementById('mTrigger');
const aside = document.getElementById('membersPanel');
mTrigger.addEventListener('click', ()=>{
  if (window.matchMedia('(max-width: 980px)').matches){
    const willExpand = aside.classList.contains('collapsed');
    aside.classList.toggle('collapsed');
    mTrigger.setAttribute('aria-expanded', willExpand ? 'true' : 'false');
  }
});
</script>
</body>
</html>
